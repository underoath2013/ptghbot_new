# Ptghbot
Тестовый бот<br />
Ознакомиться с функционалом и просмотреть работу -> @ptghbot

## Установка

1. Клонируйте репозиторий с github
2. Создайте виртуальное окружение
3. Установите зависимости командой `pip install -r requirements.txt`
4. Создайте файл `settings.py`
5. Впишите в settings.py переменные: токен вашего бота, адрес MongoDB
6. Положите любой .xlsx файл в корневой каталог с ботом
7. Запустите бота командой `python bot.py`

### Как работает бот?
Библиотека
https://python-telegram-bot.readthedocs.io

При помощи встроенного менеджера задач (JobQueue) запускает в заданный интервал (3600 сек.) времени функцию def working_with_files().

def working_with_files()
По заданной ссылке отслеживает появление нового расписания методом сравнения нужной части ссылки с именем excel файла, лежащего в корне папки с ботом.
Если на сервер загружается новый файл, ссылка меняется, загружается новый файл, старый файл удаляется, пользователи получают уведомление о доступности нового расписания.

def print_schedule()
После нажатия кнопки "Расписание" пользователю предлагаются доступные даты для выбора.
Каждый лист книги это дата.

Обработка excel файла расписания организована через библиотеку OpenpyXL.
Пользователь выбирает дату, стартует обработка файла по алгоритму:
читаются колонки ABC и EFG, отсекается ненужный мусор, строки склеиваются -> добавляются в список schedule.

При помощи регуляки и срезов выбираются названия групп и расписание для группы, эти данные добавляются в словарь dict_groups, где ключ Название группы: значение Расписание группы. Пользователю выводится список групп.

Пользователь выбирает нужную группу, начинается повторная обработка файла, отсекается остальной мусор и пользователь получает расписание для выбранной группы.

Дополнительный функционал: <br />
Вывод картинки звонков <br />
Вывод информации о боте <br />

Данные о пользователях хранятся в MongoDB по схеме: <br />
"user_id" <br />
"first_name" <br />
"last_name" <br />
"username" <br />
"chat_id" <br />
'subscribed' - подписка на рассылку о появлении нового расписания