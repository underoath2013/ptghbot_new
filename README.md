# Ptghbot
Тестовый бот<br />
Ознакомиться с функционалом и просмотреть работу -> @ptghbot

## Установка

1. Клонируйте репозиторий с github
2. Создайте виртуальное окружение
3. Установите зависимости командой `pip install -r requirements.txt`
4. Создайте файл `settings.py`
5. Впишите в settings.py переменные: токен вашего бота, адрес MongoDB
7. Запустите бота командой `python bot.py`

### Как работает бот?
Библиотека
https://python-telegram-bot.readthedocs.io

При помощи встроенного в библиотеку менеджера задач (JobQueue) запускает раз в заданный интервал (например 3600 сек.) времени функцию parsing_links_from_schedule_html_downloading_schedules().

parsing_links_from_schedule_html_downloading_schedules()
По заданной ссылке отслеживает появление нового расписания методом сравнения изменяемой  части ссылки с именем excel файлов, лежащих в папках changes_schedule и main_schedule.
Если на сервер загружается новый файл, часть ссылки меняется, загружается новый файл, старый файл удаляется, пользователи получают уведомление о доступности нового расписания. Дополнительно Изменения к расписанию сериализуются в pickle файл в папку changes_schedule, для быстрого обращения к распарсенным данным. 

Обработка excel файла расписания организована через библиотеку OpenpyXL, вызывается в функции def parsing_data().
Алгоритм парсинга хранится в system_functions.py

Пользователь нажимает кнопку Просмотреть изменения -> получает список дат, на которые доступно расписание -> выбирает дату -> выводится список групп -> выбирает нужную группу -> получает расписание для выбранной группы.

Дополнительный функционал: <br />
Скачивание основного расписания <br />
Скачивание изменений к расписанию <br />
Вывод картинки звонков <br />
Вывод информации о боте <br />

Данные о пользователях хранятся в MongoDB по схеме: <br />
"user_id" <br />
"first_name" <br />
"last_name" <br />
"username" <br />
"chat_id" <br />
'subscribed' - подписка на рассылку о появлении нового расписания